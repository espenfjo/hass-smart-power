# Power Management and Load Shedding
# This package monitors power usage and automatically sheds loads when consumption is too high

input_number:
  power_threshold:
    name: "Power Usage Threshold"
    min: 1000
    max: 20000
    step: 100
    unit_of_measurement: "W"
    icon: mdi:flash
    mode: box
    initial: 5000

  spike_duration_assumption:
    name: "Spike Duration Assumption"
    min: 5
    max: 55
    step: 5
    unit_of_measurement: "min"
    icon: mdi:timer-outline
    mode: slider
    initial: 20

  # Load shedding priority (1 = shed first, 10 = shed last)
  priority_varmtvannsbereder:
    name: "Priority: Varmtvannsbereder"
    min: 1
    max: 10
    step: 1
    icon: mdi:water-boiler
    mode: slider
    initial: 5

  priority_oljeovn_stikk:
    name: "Priority: Oljeovn Stikk"
    min: 1
    max: 10
    step: 1
    icon: mdi:radiator
    mode: slider
    initial: 1

  priority_fryser:
    name: "Priority: Fryser"
    min: 1
    max: 10
    step: 1
    icon: mdi:fridge
    mode: slider
    initial: 10

  priority_vaskemaskin:
    name: "Priority: Vaskemaskin"
    min: 1
    max: 10
    step: 1
    icon: mdi:washing-machine
    mode: slider
    initial: 3

  priority_layzspa_heat:
    name: "Priority: Hot Tub Heater"
    min: 1
    max: 10
    step: 1
    icon: mdi:hot-tub
    mode: slider
    initial: 2

  # Expected power draw for each device (in Watts)
  power_draw_varmtvannsbereder:
    name: "Power Draw: Varmtvannsbereder"
    min: 0
    max: 5000
    step: 50
    unit_of_measurement: "W"
    icon: mdi:water-boiler
    mode: box
    initial: 2000

  power_draw_oljeovn_stikk:
    name: "Power Draw: Oljeovn Stikk"
    min: 0
    max: 5000
    step: 50
    unit_of_measurement: "W"
    icon: mdi:radiator
    mode: box
    initial: 1500

  power_draw_fryser:
    name: "Power Draw: Fryser"
    min: 0
    max: 1000
    step: 10
    unit_of_measurement: "W"
    icon: mdi:fridge
    mode: box
    initial: 100

  power_draw_vaskemaskin:
    name: "Power Draw: Vaskemaskin"
    min: 0
    max: 3000
    step: 50
    unit_of_measurement: "W"
    icon: mdi:washing-machine
    mode: box
    initial: 500

  power_draw_layzspa_heat:
    name: "Power Draw: Hot Tub Heater"
    min: 0
    max: 5000
    step: 50
    unit_of_measurement: "W"
    icon: mdi:hot-tub
    mode: box
    initial: 2000

  # Minimum off-time for each device (minutes)
  min_off_time_varmtvannsbereder:
    name: "Min Off-Time: Varmtvannsbereder"
    min: 0
    max: 180
    step: 5
    unit_of_measurement: "min"
    icon: mdi:timer-sand
    mode: box
    initial: 30

  min_off_time_oljeovn_stikk:
    name: "Min Off-Time: Oljeovn Stikk"
    min: 0
    max: 180
    step: 5
    unit_of_measurement: "min"
    icon: mdi:timer-sand
    mode: box
    initial: 60

  min_off_time_fryser:
    name: "Min Off-Time: Fryser"
    min: 0
    max: 180
    step: 5
    unit_of_measurement: "min"
    icon: mdi:timer-sand
    mode: box
    initial: 120

  min_off_time_vaskemaskin:
    name: "Min Off-Time: Vaskemaskin"
    min: 0
    max: 180
    step: 5
    unit_of_measurement: "min"
    icon: mdi:timer-sand
    mode: box
    initial: 90

  min_off_time_layzspa_heat:
    name: "Min Off-Time: Hot Tub Heater"
    min: 0
    max: 180
    step: 5
    unit_of_measurement: "min"
    icon: mdi:timer-sand
    mode: box
    initial: 60

  # Anti-cycle backoff counters
  cycle_count_varmtvannsbereder:
    name: "Cycle Count: Varmtvannsbereder"
    min: 0
    max: 12
    step: 1
    icon: mdi:counter
    mode: box
    initial: 0

  cycle_count_oljeovn_stikk:
    name: "Cycle Count: Oljeovn Stikk"
    min: 0
    max: 12
    step: 1
    icon: mdi:counter
    mode: box
    initial: 0

  cycle_count_fryser:
    name: "Cycle Count: Fryser"
    min: 0
    max: 12
    step: 1
    icon: mdi:counter
    mode: box
    initial: 0

  cycle_count_vaskemaskin:
    name: "Cycle Count: Vaskemaskin"
    min: 0
    max: 12
    step: 1
    icon: mdi:counter
    mode: box
    initial: 0

  cycle_count_layzspa_heat:
    name: "Cycle Count: Hot Tub Heater"
    min: 0
    max: 12
    step: 1
    icon: mdi:counter
    mode: box
    initial: 0

  priority_sofakrok:
    name: "Priority: Sofakrok"
    min: 1
    max: 10
    step: 1
    icon: mdi:sofa
    mode: slider
    initial: 4

  priority_mill_wifi_oil:
    name: "Priority: Mill WiFi Oil"
    min: 1
    max: 10
    step: 1
    icon: mdi:radiator
    mode: slider
    initial: 2

  power_draw_sofakrok:
    name: "Power Draw: Sofakrok"
    min: 0
    max: 5000
    step: 50
    unit_of_measurement: "W"
    icon: mdi:sofa
    mode: box
    initial: 1500

  power_draw_mill_wifi_oil:
    name: "Power Draw: Mill WiFi Oil"
    min: 0
    max: 5000
    step: 50
    unit_of_measurement: "W"
    icon: mdi:radiator
    mode: box
    initial: 1500

  min_off_time_sofakrok:
    name: "Min Off-Time: Sofakrok"
    min: 0
    max: 180
    step: 5
    unit_of_measurement: "min"
    icon: mdi:timer-sand
    mode: box
    initial: 60

  min_off_time_mill_wifi_oil:
    name: "Min Off-Time: Mill WiFi Oil"
    min: 0
    max: 180
    step: 5
    unit_of_measurement: "min"
    icon: mdi:timer-sand
    mode: box
    initial: 60

  cycle_count_sofakrok:
    name: "Cycle Count: Sofakrok"
    min: 0
    max: 12
    step: 1
    icon: mdi:counter
    mode: box
    initial: 0

  cycle_count_mill_wifi_oil:
    name: "Cycle Count: Mill WiFi Oil"
    min: 0
    max: 12
    step: 1
    icon: mdi:counter
    mode: box
    initial: 0

  # Floor heating - Bathroom
  priority_varmekabler_bad:
    name: "Priority: Varmekabler Bad"
    min: 1
    max: 10
    step: 1
    icon: mdi:heating-coil
    mode: slider
    initial: 3

  power_draw_varmekabler_bad:
    name: "Power Draw: Varmekabler Bad"
    min: 0
    max: 3000
    step: 50
    unit_of_measurement: "W"
    icon: mdi:heating-coil
    mode: box
    initial: 800

  min_off_time_varmekabler_bad:
    name: "Min Off-Time: Varmekabler Bad"
    min: 0
    max: 180
    step: 5
    unit_of_measurement: "min"
    icon: mdi:timer-sand
    mode: box
    initial: 30

  cycle_count_varmekabler_bad:
    name: "Cycle Count: Varmekabler Bad"
    min: 0
    max: 12
    step: 1
    icon: mdi:counter
    mode: box
    initial: 0

  # Floor heating - Hallway
  priority_varmekabler_gang:
    name: "Priority: Varmekabler Gang"
    min: 1
    max: 10
    step: 1
    icon: mdi:heating-coil
    mode: slider
    initial: 3

  power_draw_varmekabler_gang:
    name: "Power Draw: Varmekabler Gang"
    min: 0
    max: 3000
    step: 50
    unit_of_measurement: "W"
    icon: mdi:heating-coil
    mode: box
    initial: 600

  min_off_time_varmekabler_gang:
    name: "Min Off-Time: Varmekabler Gang"
    min: 0
    max: 180
    step: 5
    unit_of_measurement: "min"
    icon: mdi:timer-sand
    mode: box
    initial: 30

  cycle_count_varmekabler_gang:
    name: "Cycle Count: Varmekabler Gang"
    min: 0
    max: 12
    step: 1
    icon: mdi:counter
    mode: box
    initial: 0

  # Guest room heater
  priority_varmeovn_gjesterom:
    name: "Priority: Varmeovn Gjesterom"
    min: 1
    max: 10
    step: 1
    icon: mdi:radiator
    mode: slider
    initial: 3

  power_draw_varmeovn_gjesterom:
    name: "Power Draw: Varmeovn Gjesterom"
    min: 0
    max: 3000
    step: 50
    unit_of_measurement: "W"
    icon: mdi:radiator
    mode: box
    initial: 1000

  min_off_time_varmeovn_gjesterom:
    name: "Min Off-Time: Varmeovn Gjesterom"
    min: 0
    max: 180
    step: 5
    unit_of_measurement: "min"
    icon: mdi:timer-sand
    mode: box
    initial: 30

  cycle_count_varmeovn_gjesterom:
    name: "Cycle Count: Varmeovn Gjesterom"
    min: 0
    max: 12
    step: 1
    icon: mdi:counter
    mode: box
    initial: 0

  # Total shed counters (lifetime)
  total_sheds_varmtvannsbereder:
    name: "Total Sheds: Varmtvannsbereder"
    min: 0
    max: 10000
    step: 1
    icon: mdi:counter
    mode: box
    initial: 0

  total_sheds_oljeovn_stikk:
    name: "Total Sheds: Oljeovn Stikk"
    min: 0
    max: 10000
    step: 1
    icon: mdi:counter
    mode: box
    initial: 0

  total_sheds_fryser:
    name: "Total Sheds: Fryser"
    min: 0
    max: 10000
    step: 1
    icon: mdi:counter
    mode: box
    initial: 0

  total_sheds_vaskemaskin:
    name: "Total Sheds: Vaskemaskin"
    min: 0
    max: 10000
    step: 1
    icon: mdi:counter
    mode: box
    initial: 0

  total_sheds_layzspa_heat:
    name: "Total Sheds: Hot Tub"
    min: 0
    max: 10000
    step: 1
    icon: mdi:counter
    mode: box
    initial: 0

  total_sheds_sofakrok:
    name: "Total Sheds: Sofakrok"
    min: 0
    max: 10000
    step: 1
    icon: mdi:counter
    mode: box
    initial: 0

  total_sheds_mill_wifi_oil:
    name: "Total Sheds: Mill WiFi Oil"
    min: 0
    max: 10000
    step: 1
    icon: mdi:counter
    mode: box
    initial: 0

  total_sheds_varmekabler_bad:
    name: "Total Sheds: Varmekabler Bad"
    min: 0
    max: 10000
    step: 1
    icon: mdi:counter
    mode: box
    initial: 0

  total_sheds_varmekabler_gang:
    name: "Total Sheds: Varmekabler Gang"
    min: 0
    max: 10000
    step: 1
    icon: mdi:counter
    mode: box
    initial: 0

  total_sheds_varmeovn_gjesterom:
    name: "Total Sheds: Varmeovn Gjesterom"
    min: 0
    max: 10000
    step: 1
    icon: mdi:counter
    mode: box
    initial: 0

  # Hourly average tracking
  last_hour_average_power:
    name: "Last Hour Average Power"
    min: 0
    max: 50000
    step: 1
    unit_of_measurement: "W"
    icon: mdi:history
    mode: box

  # Døgnmaks tracking - Today's peak and top 3 monthly peaks
  todays_peak_power:
    name: "Today's Peak Hour (Døgnmaks)"
    min: 0
    max: 50000
    step: 1
    unit_of_measurement: "W"
    icon: mdi:chart-bar
    mode: box

  monthly_peak_1:
    name: "Monthly Peak #1"
    min: 0
    max: 50000
    step: 1
    unit_of_measurement: "W"
    icon: mdi:podium-gold
    mode: box

  monthly_peak_2:
    name: "Monthly Peak #2"
    min: 0
    max: 50000
    step: 1
    unit_of_measurement: "W"
    icon: mdi:podium-silver
    mode: box

  monthly_peak_3:
    name: "Monthly Peak #3"
    min: 0
    max: 50000
    step: 1
    unit_of_measurement: "W"
    icon: mdi:podium-bronze
    mode: box

input_boolean:
  load_shedding_enabled:
    name: "Enable Automatic Load Shedding"
    icon: mdi:power-plug-off

  load_shedding_varmtvannsbereder:
    name: "Load Shed: Varmtvannsbereder"
    icon: mdi:water-boiler
    initial: true

  load_shedding_oljeovn_stikk:
    name: "Load Shed: Oljeovn Stikk"
    icon: mdi:radiator
    initial: true

  load_shedding_fryser:
    name: "Load Shed: Fryser"
    icon: mdi:fridge
    initial: false

  load_shedding_vaskemaskin:
    name: "Load Shed: Vaskemaskin"
    icon: mdi:washing-machine
    initial: false

  load_shedding_layzspa_heat:
    name: "Load Shed: Hot Tub Heater"
    icon: mdi:hot-tub
    initial: true

  load_shedding_sofakrok:
    name: "Load Shed: Sofakrok"
    icon: mdi:sofa
    initial: true

  load_shedding_mill_wifi_oil:
    name: "Load Shed: Mill WiFi Oil"
    icon: mdi:radiator
    initial: true

  load_shedding_varmekabler_bad:
    name: "Load Shed: Varmekabler Bad"
    icon: mdi:heating-coil
    initial: true

  load_shedding_varmekabler_gang:
    name: "Load Shed: Varmekabler Gang"
    icon: mdi:heating-coil
    initial: true

  load_shedding_varmeovn_gjesterom:
    name: "Load Shed: Varmeovn Gjesterom"
    icon: mdi:radiator
    initial: true

  # Track which devices were automatically shed (for restoration)
  was_shed_varmtvannsbereder:
    name: "Was Shed: Varmtvannsbereder"
    icon: mdi:water-boiler-off
    initial: false

  was_shed_oljeovn_stikk:
    name: "Was Shed: Oljeovn Stikk"
    icon: mdi:radiator-off
    initial: false

  was_shed_fryser:
    name: "Was Shed: Fryser"
    icon: mdi:fridge-off
    initial: false

  was_shed_vaskemaskin:
    name: "Was Shed: Vaskemaskin"
    icon: mdi:washing-machine-off
    initial: false

  was_shed_layzspa_heat:
    name: "Was Shed: Hot Tub Heater"
    icon: mdi:hot-tub
    initial: false

  was_shed_sofakrok:
    name: "Was Shed: Sofakrok"
    icon: mdi:sofa-off
    initial: false

  was_shed_mill_wifi_oil:
    name: "Was Shed: Mill WiFi Oil"
    icon: mdi:radiator-off
    initial: false

  was_shed_varmekabler_bad:
    name: "Was Shed: Varmekabler Bad"
    icon: mdi:heating-coil
    initial: false

  was_shed_varmekabler_gang:
    name: "Was Shed: Varmekabler Gang"
    icon: mdi:heating-coil
    initial: false

  was_shed_varmeovn_gjesterom:
    name: "Was Shed: Varmeovn Gjesterom"
    icon: mdi:radiator-off
    initial: false

  auto_restore_devices:
    name: "Auto-Restore Devices After Load Shedding"
    icon: mdi:restore
    initial: true

  smart_shedding_mode:
    name: "Smart Shedding Mode"
    icon: mdi:brain
    initial: true

  anti_cycling_protection:
    name: "Anti-Cycling Protection"
    icon: mdi:sync-alert
    initial: true

input_datetime:
  # Track last shed time for each device
  last_shed_varmtvannsbereder:
    name: "Last Shed: Varmtvannsbereder"
    has_date: true
    has_time: true

  last_shed_oljeovn_stikk:
    name: "Last Shed: Oljeovn Stikk"
    has_date: true
    has_time: true

  last_shed_fryser:
    name: "Last Shed: Fryser"
    has_date: true
    has_time: true

  last_shed_vaskemaskin:
    name: "Last Shed: Vaskemaskin"
    has_date: true
    has_time: true

  last_shed_layzspa_heat:
    name: "Last Shed: Hot Tub Heater"
    has_date: true
    has_time: true

  last_shed_sofakrok:
    name: "Last Shed: Sofakrok"
    has_date: true
    has_time: true

  last_shed_mill_wifi_oil:
    name: "Last Shed: Mill WiFi Oil"
    has_date: true
    has_time: true

  last_shed_varmekabler_bad:
    name: "Last Shed: Varmekabler Bad"
    has_date: true
    has_time: true

  last_shed_varmekabler_gang:
    name: "Last Shed: Varmekabler Gang"
    has_date: true
    has_time: true

  last_shed_varmeovn_gjesterom:
    name: "Last Shed: Varmeovn Gjesterom"
    has_date: true
    has_time: true

  # Track last restore time for each device
  last_restore_varmtvannsbereder:
    name: "Last Restore: Varmtvannsbereder"
    has_date: true
    has_time: true

  last_restore_oljeovn_stikk:
    name: "Last Restore: Oljeovn Stikk"
    has_date: true
    has_time: true

  last_restore_fryser:
    name: "Last Restore: Fryser"
    has_date: true
    has_time: true

  last_restore_vaskemaskin:
    name: "Last Restore: Vaskemaskin"
    has_date: true
    has_time: true

  last_restore_layzspa_heat:
    name: "Last Restore: Hot Tub Heater"
    has_date: true
    has_time: true

  last_restore_sofakrok:
    name: "Last Restore: Sofakrok"
    has_date: true
    has_time: true

  last_restore_mill_wifi_oil:
    name: "Last Restore: Mill WiFi Oil"
    has_date: true
    has_time: true

  last_restore_varmekabler_bad:
    name: "Last Restore: Varmekabler Bad"
    has_date: true
    has_time: true

  last_restore_varmekabler_gang:
    name: "Last Restore: Varmekabler Gang"
    has_date: true
    has_time: true

  last_restore_varmeovn_gjesterom:
    name: "Last Restore: Varmeovn Gjesterom"
    has_date: true
    has_time: true

#########################################################################
# Utility Meter - Hourly energy tracking for average power calculation
#########################################################################
utility_meter:
  hourly_energy:
    name: "Hourly Energy Consumption"
    source: sensor.aidon_fixed
    cycle: hourly

template:
  - sensor:
      - name: "Power Usage Status"
        unique_id: power_usage_status
        state: >
          {% set current = states('sensor.aidon_active_power_import') | float(0) %}
          {% set threshold = states('input_number.power_threshold') | float(5000) %}
          {% if current > threshold %}
            critical
          {% elif current > threshold * 0.8 %}
            warning
          {% else %}
            normal
          {% endif %}
        icon: >
          {% set current = states('sensor.aidon_active_power_import') | float(0) %}
          {% set threshold = states('input_number.power_threshold') | float(5000) %}
          {% if current > threshold %}
            mdi:flash-alert
          {% elif current > threshold * 0.8 %}
            mdi:flash
          {% else %}
            mdi:flash-outline
          {% endif %}
        attributes:
          current_power_kw: >
            {{ (states('sensor.aidon_active_power_import') | float(0) / 1000) | round(2) }}
          threshold_kw: >
            {{ (states('input_number.power_threshold') | float(5000) / 1000) | round(2) }}
          percentage_of_threshold: >
            {% set current = states('sensor.aidon_active_power_import') | float(0) %}
            {% set threshold = states('input_number.power_threshold') | float(5000) %}
            {{ ((current / threshold * 100) | round(1)) if threshold > 0 else 0 }}
          load_shedding_enabled: >
            {{ is_state('input_boolean.load_shedding_enabled', 'on') }}
          devices_configured: >
            {% set count = 0 %}
            {% if is_state('input_boolean.load_shedding_varmtvannsbereder', 'on') %}{% set count = count + 1 %}{% endif %}
            {% if is_state('input_boolean.load_shedding_oljeovn_stikk', 'on') %}{% set count = count + 1 %}{% endif %}
            {% if is_state('input_boolean.load_shedding_fryser', 'on') %}{% set count = count + 1 %}{% endif %}
            {% if is_state('input_boolean.load_shedding_vaskemaskin', 'on') %}{% set count = count + 1 %}{% endif %}
            {% if is_state('input_boolean.load_shedding_layzspa_heat', 'on') %}{% set count = count + 1 %}{% endif %}
            {% if is_state('input_boolean.load_shedding_sofakrok', 'on') %}{% set count = count + 1 %}{% endif %}
            {% if is_state('input_boolean.load_shedding_mill_wifi_oil', 'on') %}{% set count = count + 1 %}{% endif %}
            {% if is_state('input_boolean.load_shedding_varmekabler_bad', 'on') %}{% set count = count + 1 %}{% endif %}
            {% if is_state('input_boolean.load_shedding_varmekabler_gang', 'on') %}{% set count = count + 1 %}{% endif %}
            {% if is_state('input_boolean.load_shedding_varmeovn_gjesterom', 'on') %}{% set count = count + 1 %}{% endif %}
            {{ count }}
          total_sheddable_power: >
            {% set total = 0 %}
            {% if is_state('input_boolean.load_shedding_varmtvannsbereder', 'on') and is_state('switch.varmtvannsbereder', 'on') %}
              {% set total = total + states('input_number.power_draw_varmtvannsbereder') | int %}
            {% endif %}
            {% if is_state('input_boolean.load_shedding_oljeovn_stikk', 'on') and is_state('switch.oljeovn_stikk', 'on') %}
              {% set total = total + states('input_number.power_draw_oljeovn_stikk') | int %}
            {% endif %}
            {% if is_state('input_boolean.load_shedding_fryser', 'on') and is_state('switch.fryser', 'on') %}
              {% set total = total + states('input_number.power_draw_fryser') | int %}
            {% endif %}
            {% if is_state('input_boolean.load_shedding_vaskemaskin', 'on') and is_state('switch.vaskemaskin_strom', 'on') %}
              {% set total = total + states('input_number.power_draw_vaskemaskin') | int %}
            {% endif %}
            {% if is_state('input_boolean.load_shedding_layzspa_heat', 'on') and is_state('switch.layzspa_wifi_controller_layzspa_heat_regulation', 'on') %}
              {% set total = total + states('input_number.power_draw_layzspa_heat') | int %}
            {% endif %}
            {% if is_state('input_boolean.load_shedding_sofakrok', 'on') and not is_state('climate.sofakrok', 'off') %}
              {% set total = total + states('input_number.power_draw_sofakrok') | int %}
            {% endif %}
            {% if is_state('input_boolean.load_shedding_mill_wifi_oil', 'on') and not is_state('climate.mill_wi_fi_oil', 'off') %}
              {% set total = total + states('input_number.power_draw_mill_wifi_oil') | int %}
            {% endif %}
            {% if is_state('input_boolean.load_shedding_varmekabler_bad', 'on') and not is_state('climate.varmekabler_bad', 'off') %}
              {% set total = total + states('input_number.power_draw_varmekabler_bad') | int %}
            {% endif %}
            {% if is_state('input_boolean.load_shedding_varmekabler_gang', 'on') and not is_state('climate.varmekabler_gang', 'off') %}
              {% set total = total + states('input_number.power_draw_varmekabler_gang') | int %}
            {% endif %}
            {% if is_state('input_boolean.load_shedding_varmeovn_gjesterom', 'on') and is_state('switch.varmeovn_gjesterom', 'on') %}
              {% set total = total + states('input_number.power_draw_varmeovn_gjesterom') | int %}
            {% endif %}
            {{ (total / 1000) | round(2) }}
          estimated_power_after_shedding: >
            {% set current = states('sensor.aidon_active_power_import') | float(0) %}
            {% set sheddable = state_attr('sensor.power_usage_status', 'total_sheddable_power') | float(0) * 1000 %}
            {{ ((current - sheddable) / 1000) | round(2) }}
          power_over_threshold: >
            {% set current = states('sensor.aidon_active_power_import') | float(0) %}
            {% set threshold = states('input_number.power_threshold') | float(5000) %}
            {{ ((current - threshold) / 1000) | round(2) if current > threshold else 0 }}

      #####################################################################
      # Hourly Power Tracking - for billing-aware load shedding
      #####################################################################
      - name: "Current Hour Average Power"
        unique_id: current_hour_average_power
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set energy_kwh = states('sensor.hourly_energy_consumption') | float(0) %}
          {% set minutes_elapsed = now().minute + (now().second / 60) %}
          {% if minutes_elapsed < 1 %}
            {% set minutes_elapsed = 1 %}
          {% endif %}
          {% set hours_elapsed = minutes_elapsed / 60 %}
          {{ ((energy_kwh / hours_elapsed) * 1000) | round(0) }}
        icon: mdi:chart-timeline-variant
        attributes:
          energy_this_hour_kwh: >
            {{ states('sensor.hourly_energy_consumption') | float(0) | round(3) }}
          minutes_elapsed: >
            {{ now().minute }}
          minutes_remaining: >
            {{ 60 - now().minute }}

      - name: "Projected Hourly Power"
        unique_id: projected_hourly_power
        unit_of_measurement: "W"
        device_class: power
        state: >
          {% set energy_kwh = states('sensor.hourly_energy_consumption') | float(0) %}
          {% set smoothed_power = states('sensor.power_5min_average') | float(0) %}
          {% set minutes_elapsed = now().minute + (now().second / 60) %}
          {% if minutes_elapsed < 1 %}
            {% set minutes_elapsed = 1 %}
          {% endif %}
          {% set minutes_remaining = 60 - minutes_elapsed %}
          {% set current_avg = (energy_kwh / (minutes_elapsed / 60)) * 1000 %}
          {# Only assume current power continues for configured duration, then baseline #}
          {% set spike_duration = states('input_number.spike_duration_assumption') | int(20) %}
          {% set spike_minutes = [spike_duration, minutes_remaining] | min %}
          {% set baseline_minutes = minutes_remaining - spike_minutes %}
          {# Use historical baseline (lower of current_avg or smoothed) for post-spike #}
          {% set baseline = [current_avg, smoothed_power] | min %}
          {% set projected = ((current_avg * minutes_elapsed) + (smoothed_power * spike_minutes) + (baseline * baseline_minutes)) / 60 %}
          {{ projected | round(0) }}
        icon: mdi:chart-line
        attributes:
          current_power_w: >
            {{ states('sensor.aidon_active_power_import') | float(0) | round(0) }}
          smoothed_power_w: >
            {{ states('sensor.power_5min_average') | float(0) | round(0) }}
          current_average_w: >
            {{ states('sensor.current_hour_average_power') | float(0) | round(0) }}
          spike_assumption_min: >
            {{ states('input_number.spike_duration_assumption') | int(20) }}

      - name: "Hourly Power Margin"
        unique_id: hourly_power_margin
        unit_of_measurement: "W"
        device_class: power
        state: >
          {% set threshold = states('sensor.next_tier_threshold') | float(5000) %}
          {% set projected = states('sensor.projected_hourly_power') | float(0) %}
          {{ (threshold - projected) | round(0) }}
        icon: >
          {% set margin = states('sensor.hourly_power_margin') | float(0) %}
          {% if margin < 0 %}
            mdi:alert-circle
          {% elif margin < 500 %}
            mdi:alert
          {% else %}
            mdi:check-circle
          {% endif %}
        attributes:
          threshold_w: >
            {{ states('sensor.next_tier_threshold') | float(5000) | round(0) }}
          projected_w: >
            {{ states('sensor.projected_hourly_power') | float(0) | round(0) }}
          status: >
            {% set margin = states('sensor.hourly_power_margin') | float(0) %}
            {% if margin < 0 %}
              over_budget
            {% elif margin < 500 %}
              tight
            {% else %}
              ok
            {% endif %}

      - name: "Power Analytics"
        unique_id: power_analytics
        state: >
          {{ states('sensor.aidon_active_power_import') | float(0) | round(0) }}
        unit_of_measurement: "W"
        device_class: power
        attributes:
          highest_cycle_count: >
            {% set counts = [
              states('input_number.cycle_count_varmtvannsbereder') | int,
              states('input_number.cycle_count_oljeovn_stikk') | int,
              states('input_number.cycle_count_fryser') | int,
              states('input_number.cycle_count_vaskemaskin') | int,
              states('input_number.cycle_count_layzspa_heat') | int,
              states('input_number.cycle_count_sofakrok') | int,
              states('input_number.cycle_count_mill_wifi_oil') | int,
              states('input_number.cycle_count_varmekabler_bad') | int,
              states('input_number.cycle_count_varmekabler_gang') | int,
              states('input_number.cycle_count_varmeovn_gjesterom') | int
            ] %}
            {{ counts | max }}
          highest_cycle_device: >
            {% set devices = [
              {'name': 'Varmtvannsbereder', 'count': states('input_number.cycle_count_varmtvannsbereder') | int},
              {'name': 'Oljeovn Stikk', 'count': states('input_number.cycle_count_oljeovn_stikk') | int},
              {'name': 'Fryser', 'count': states('input_number.cycle_count_fryser') | int},
              {'name': 'Vaskemaskin', 'count': states('input_number.cycle_count_vaskemaskin') | int},
              {'name': 'Hot Tub', 'count': states('input_number.cycle_count_layzspa_heat') | int},
              {'name': 'Sofakrok', 'count': states('input_number.cycle_count_sofakrok') | int},
              {'name': 'Mill WiFi Oil', 'count': states('input_number.cycle_count_mill_wifi_oil') | int},
              {'name': 'Varmekabler Bad', 'count': states('input_number.cycle_count_varmekabler_bad') | int},
              {'name': 'Varmekabler Gang', 'count': states('input_number.cycle_count_varmekabler_gang') | int},
              {'name': 'Varmeovn Gjesterom', 'count': states('input_number.cycle_count_varmeovn_gjesterom') | int}
            ] %}
            {% set max_device = devices | sort(attribute='count', reverse=true) | first %}
            {{ max_device.name if max_device.count > 0 else 'None' }}
          devices_currently_shed: >
            {% set count = 0 %}
            {% if is_state('input_boolean.was_shed_varmtvannsbereder', 'on') %}{% set count = count + 1 %}{% endif %}
            {% if is_state('input_boolean.was_shed_oljeovn_stikk', 'on') %}{% set count = count + 1 %}{% endif %}
            {% if is_state('input_boolean.was_shed_fryser', 'on') %}{% set count = count + 1 %}{% endif %}
            {% if is_state('input_boolean.was_shed_vaskemaskin', 'on') %}{% set count = count + 1 %}{% endif %}
            {% if is_state('input_boolean.was_shed_layzspa_heat', 'on') %}{% set count = count + 1 %}{% endif %}
            {% if is_state('input_boolean.was_shed_sofakrok', 'on') %}{% set count = count + 1 %}{% endif %}
            {% if is_state('input_boolean.was_shed_mill_wifi_oil', 'on') %}{% set count = count + 1 %}{% endif %}
            {% if is_state('input_boolean.was_shed_varmekabler_bad', 'on') %}{% set count = count + 1 %}{% endif %}
            {% if is_state('input_boolean.was_shed_varmekabler_gang', 'on') %}{% set count = count + 1 %}{% endif %}
            {% if is_state('input_boolean.was_shed_varmeovn_gjesterom', 'on') %}{% set count = count + 1 %}{% endif %}
            {{ count }}
          system_health: >
            {% set anti_cycling = is_state('input_boolean.anti_cycling_protection', 'on') %}
            {% set load_shedding = is_state('input_boolean.load_shedding_enabled', 'on') %}
            {% set max_cycles = state_attr('sensor.power_analytics', 'highest_cycle_count') | int(0) %}
            {% if not anti_cycling and not load_shedding %}
              disabled
            {% elif max_cycles >= 5 %}
              warning
            {% elif max_cycles >= 3 %}
              caution
            {% else %}
              healthy
            {% endif %}
          recommendation: >
            {% set sheddable = state_attr('sensor.power_usage_status', 'total_sheddable_power') | float(0) %}
            {% set over = state_attr('sensor.power_usage_status', 'power_over_threshold') | float(0) %}
            {% set max_cycles = state_attr('sensor.power_analytics', 'highest_cycle_count') | int(0) %}
            {% if over > 0 and sheddable < over %}
              Insufficient sheddable power! Consider enabling more devices or increasing threshold.
            {% elif max_cycles >= 5 %}
              High cycling detected. Increase min off-time for {{ state_attr('sensor.power_analytics', 'highest_cycle_device') }}.
            {% elif max_cycles >= 3 %}
              Moderate cycling on {{ state_attr('sensor.power_analytics', 'highest_cycle_device') }}. Monitor closely.
            {% else %}
              System operating normally. No action needed.
            {% endif %}

      #####################################################################
      # Døgnmaks & Fastledd Tracking
      #####################################################################
      - name: "Fastledd Average"
        unique_id: fastledd_average
        unit_of_measurement: "W"
        device_class: power
        state: >
          {# Include today's effective peak (max of stored peak and current hour) #}
          {% set today_peak = states('input_number.todays_peak_power') | float(0) %}
          {% set current_avg = states('sensor.current_hour_average_power') | float(0) %}
          {% set effective_today = [today_peak, current_avg] | max %}
          {% set p1 = states('input_number.monthly_peak_1') | float(0) %}
          {% set p2 = states('input_number.monthly_peak_2') | float(0) %}
          {% set p3 = states('input_number.monthly_peak_3') | float(0) %}
          {# Combine today with stored peaks and take top 3 #}
          {% set all_peaks = [effective_today, p1, p2, p3] | sort(reverse=true) %}
          {% set top3 = all_peaks[:3] | select('gt', 0) | list %}
          {% if top3 | length > 0 %}
            {{ (top3 | sum / top3 | length) | round(0) }}
          {% else %}
            0
          {% endif %}
        icon: mdi:speedometer
        attributes:
          effective_today_w: >
            {% set today_peak = states('input_number.todays_peak_power') | float(0) %}
            {% set current_avg = states('sensor.current_hour_average_power') | float(0) %}
            {{ [today_peak, current_avg] | max | round(0) }}
          peak_1_w: "{{ states('input_number.monthly_peak_1') | float(0) | round(0) }}"
          peak_1_date: "{{ states('input_text.monthly_peak_1_date') }}"
          peak_2_w: "{{ states('input_number.monthly_peak_2') | float(0) | round(0) }}"
          peak_2_date: "{{ states('input_text.monthly_peak_2_date') }}"
          peak_3_w: "{{ states('input_number.monthly_peak_3') | float(0) | round(0) }}"
          peak_3_date: "{{ states('input_text.monthly_peak_3_date') }}"
          peaks_recorded: >
            {% set p1 = states('input_number.monthly_peak_1') | float(0) %}
            {% set p2 = states('input_number.monthly_peak_2') | float(0) %}
            {% set p3 = states('input_number.monthly_peak_3') | float(0) %}
            {{ [p1, p2, p3] | select('gt', 0) | list | length }}
          includes_today: >
            {% set today_peak = states('input_number.todays_peak_power') | float(0) %}
            {% set current_avg = states('sensor.current_hour_average_power') | float(0) %}
            {% set effective_today = [today_peak, current_avg] | max %}
            {% set p3 = states('input_number.monthly_peak_3') | float(0) %}
            {{ effective_today > p3 or p3 == 0 }}

      - name: "Fastledd Tier"
        unique_id: fastledd_tier
        state: >
          {% set avg = states('sensor.fastledd_average') | float(0) %}
          {% set avg_kw = avg / 1000 %}
          {% if avg_kw <= 2 %}Trinn 1 (0-2 kW)
          {% elif avg_kw <= 5 %}Trinn 2 (2-5 kW)
          {% elif avg_kw <= 10 %}Trinn 3 (5-10 kW)
          {% elif avg_kw <= 15 %}Trinn 4 (10-15 kW)
          {% elif avg_kw <= 20 %}Trinn 5 (15-20 kW)
          {% elif avg_kw <= 25 %}Trinn 6 (20-25 kW)
          {% else %}Trinn 7 (25+ kW)
          {% endif %}
        icon: mdi:stairs
        attributes:
          average_kw: "{{ (states('sensor.fastledd_average') | float(0) / 1000) | round(2) }}"
          tier_number: >
            {% set avg_kw = states('sensor.fastledd_average') | float(0) / 1000 %}
            {% if avg_kw <= 2 %}1
            {% elif avg_kw <= 5 %}2
            {% elif avg_kw <= 10 %}3
            {% elif avg_kw <= 15 %}4
            {% elif avg_kw <= 20 %}5
            {% elif avg_kw <= 25 %}6
            {% else %}7{% endif %}

      - name: "Today Peak Status"
        unique_id: today_peak_status
        state: >
          {% set today_peak = states('input_number.todays_peak_power') | float(0) %}
          {% set current_avg = states('sensor.current_hour_average_power') | float(0) %}
          {% set effective_peak = [today_peak, current_avg] | max %}
          Peak: {{ (effective_peak / 1000) | round(2) }} kW
        icon: >
          {% set today_peak = states('input_number.todays_peak_power') | float(0) %}
          {% set current_avg = states('sensor.current_hour_average_power') | float(0) %}
          {% set effective_peak = [today_peak, current_avg] | max %}
          {% set next_threshold = states('sensor.next_tier_threshold') | float(5000) %}
          {% if effective_peak > next_threshold %}mdi:alert-circle
          {% elif effective_peak > next_threshold * 0.8 %}mdi:alert
          {% else %}mdi:check-circle{% endif %}
        attributes:
          todays_peak_w: "{{ states('input_number.todays_peak_power') | float(0) | round(0) }}"
          todays_peak_kw: "{{ (states('input_number.todays_peak_power') | float(0) / 1000) | round(2) }}"
          current_hour_avg_w: "{{ states('sensor.current_hour_average_power') | float(0) | round(0) }}"
          effective_peak_kw: >
            {% set today_peak = states('input_number.todays_peak_power') | float(0) %}
            {% set current_avg = states('sensor.current_hour_average_power') | float(0) %}
            {{ ([today_peak, current_avg] | max / 1000) | round(2) }}
          would_affect_fastledd: >
            {% set today_peak = states('input_number.todays_peak_power') | float(0) %}
            {% set p3 = states('input_number.monthly_peak_3') | float(0) %}
            {{ today_peak > p3 or p3 == 0 }}

      #####################################################################
      # Smart Shedding - Only protect the NEXT tier threshold
      # If today's peak is already 6 kW, no point shedding for 5 kW tier
      #####################################################################
      - name: "Next Tier Threshold"
        unique_id: next_tier_threshold
        unit_of_measurement: "W"
        device_class: power
        state: >
          {# Get effective peak: max of stored peak and current hour avg #}
          {% set today_peak = states('input_number.todays_peak_power') | float(0) %}
          {% set current_avg = states('sensor.current_hour_average_power') | float(0) %}
          {% set effective_peak = [today_peak, current_avg] | max %}
          {% set desired = states('input_number.power_threshold') | float(5000) %}
          {# Tier boundaries in W: 2000, 5000, 10000, 15000, 20000, 25000 #}
          {% set tiers = [2000, 5000, 10000, 15000, 20000, 25000] %}
          {# If under desired threshold, protect that #}
          {% if effective_peak < desired %}
            {{ desired | int }}
          {% else %}
            {# Find next tier above effective peak #}
            {% set next = namespace(tier=25000) %}
            {% for t in tiers %}
              {% if t > effective_peak and t > desired %}
                {% set next.tier = t %}
                {% break %}
              {% endif %}
            {% endfor %}
            {{ next.tier }}
          {% endif %}
        icon: mdi:target
        attributes:
          effective_peak_kw: >
            {% set today_peak = states('input_number.todays_peak_power') | float(0) %}
            {% set current_avg = states('sensor.current_hour_average_power') | float(0) %}
            {{ ([today_peak, current_avg] | max / 1000) | round(2) }}
          desired_threshold_kw: >
            {{ (states('input_number.power_threshold') | float(5000) / 1000) | round(1) }}
          current_tier: >
            {% set today_peak = states('input_number.todays_peak_power') | float(0) %}
            {% set current_avg = states('sensor.current_hour_average_power') | float(0) %}
            {% set effective_peak_kw = [today_peak, current_avg] | max / 1000 %}
            {% if effective_peak_kw < 2 %}0-2 kW
            {% elif effective_peak_kw < 5 %}2-5 kW
            {% elif effective_peak_kw < 10 %}5-10 kW
            {% elif effective_peak_kw < 15 %}10-15 kW
            {% elif effective_peak_kw < 20 %}15-20 kW
            {% else %}20+ kW{% endif %}
          protecting: >
            {{ (states('sensor.next_tier_threshold') | float(5000) / 1000) | round(0) }} kW threshold
          day_already_lost: >
            {# True if today's peak already exceeded the user's desired threshold #}
            {% set today_peak = states('input_number.todays_peak_power') | float(0) %}
            {% set desired = states('input_number.power_threshold') | float(5000) %}
            {{ today_peak > desired }}

      - name: "Smart Shedding Required"
        unique_id: smart_shedding_required
        state: >
          {% set projected = states('sensor.projected_hourly_power') | float(0) %}
          {% set next_threshold = states('sensor.next_tier_threshold') | float(5000) %}
          {% set minutes = now().minute %}
          {# Less aggressive: only trigger when close to threshold #}
          {% if minutes < 15 %}
            {% set trigger_pct = 0.95 %}
          {% elif minutes < 30 %}
            {% set trigger_pct = 0.97 %}
          {% elif minutes < 45 %}
            {% set trigger_pct = 0.98 %}
          {% else %}
            {% set trigger_pct = 0.99 %}
          {% endif %}
          {{ projected > (next_threshold * trigger_pct) }}
        icon: >
          {% if is_state('sensor.smart_shedding_required', 'True') %}
            mdi:flash-alert
          {% else %}
            mdi:flash-check
          {% endif %}
        attributes:
          projected_w: "{{ states('sensor.projected_hourly_power') | float(0) | round(0) }}"
          next_threshold_w: "{{ states('sensor.next_tier_threshold') | float(0) | round(0) }}"
          trigger_percentage: >
            {% set minutes = now().minute %}
            {% if minutes < 15 %}95%
            {% elif minutes < 30 %}97%
            {% elif minutes < 45 %}98%
            {% else %}99%{% endif %}
          margin_to_threshold_w: >
            {% set projected = states('sensor.projected_hourly_power') | float(0) %}
            {% set next_threshold = states('sensor.next_tier_threshold') | float(5000) %}
            {{ (next_threshold - projected) | round(0) }}
          reason: >
            {% set projected = states('sensor.projected_hourly_power') | float(0) %}
            {% set next_threshold = states('sensor.next_tier_threshold') | float(5000) %}
            {% set today_peak = states('input_number.todays_peak_power') | float(0) %}
            {% if projected > next_threshold %}
              Projected {{ (projected/1000)|round(2) }} kW exceeds {{ (next_threshold/1000)|round(0) }} kW threshold
            {% elif today_peak > states('input_number.power_threshold') | float(5000) %}
              Day already lost (peak {{ (today_peak/1000)|round(2) }} kW), protecting next tier
            {% else %}
              Under threshold, no shedding needed
            {% endif %}

# Smoothed power sensor (5-minute average) to avoid reacting to short spikes
sensor:
  - platform: statistics
    name: "Power 5min Average"
    entity_id: sensor.aidon_active_power_import
    state_characteristic: mean
    sampling_size: 300
    max_age:
      minutes: 5

# History stats sensors to track shed time (for fairness-based shedding)
  - platform: history_stats
    name: "Shed Time 24h: Varmtvannsbereder"
    entity_id: input_boolean.was_shed_varmtvannsbereder
    state: "on"
    type: time
    start: "{{ now() - timedelta(hours=24) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "Shed Time 24h: Oljeovn Stikk"
    entity_id: input_boolean.was_shed_oljeovn_stikk
    state: "on"
    type: time
    start: "{{ now() - timedelta(hours=24) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "Shed Time 24h: Fryser"
    entity_id: input_boolean.was_shed_fryser
    state: "on"
    type: time
    start: "{{ now() - timedelta(hours=24) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "Shed Time 24h: Vaskemaskin"
    entity_id: input_boolean.was_shed_vaskemaskin
    state: "on"
    type: time
    start: "{{ now() - timedelta(hours=24) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "Shed Time 24h: Hot Tub"
    entity_id: input_boolean.was_shed_layzspa_heat
    state: "on"
    type: time
    start: "{{ now() - timedelta(hours=24) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "Shed Time 24h: Sofakrok"
    entity_id: input_boolean.was_shed_sofakrok
    state: "on"
    type: time
    start: "{{ now() - timedelta(hours=24) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "Shed Time 24h: Mill WiFi Oil"
    entity_id: input_boolean.was_shed_mill_wifi_oil
    state: "on"
    type: time
    start: "{{ now() - timedelta(hours=24) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "Shed Time 24h: Varmekabler Bad"
    entity_id: input_boolean.was_shed_varmekabler_bad
    state: "on"
    type: time
    start: "{{ now() - timedelta(hours=24) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "Shed Time 24h: Varmekabler Gang"
    entity_id: input_boolean.was_shed_varmekabler_gang
    state: "on"
    type: time
    start: "{{ now() - timedelta(hours=24) }}"
    end: "{{ now() }}"

  - platform: history_stats
    name: "Shed Time 24h: Varmeovn Gjesterom"
    entity_id: input_boolean.was_shed_varmeovn_gjesterom
    state: "on"
    type: time
    start: "{{ now() - timedelta(hours=24) }}"
    end: "{{ now() }}"

#########################################################################
# Døgnmaks Tracking - Norwegian "Fastledd" billing model
# Fastledd = average of 3 highest daily peaks (from 3 different days)
#########################################################################

# Store the dates of the top 3 peaks (to ensure different days)
input_text:
  monthly_peak_1_date:
    name: "Peak #1 Date"
    max: 10
    icon: mdi:calendar

  monthly_peak_2_date:
    name: "Peak #2 Date"
    max: 10
    icon: mdi:calendar

  monthly_peak_3_date:
    name: "Peak #3 Date"
    max: 10
    icon: mdi:calendar

  # Store previous hvac_mode for climate devices (for restoration after shedding)
  previous_hvac_mode_sofakrok:
    name: "Previous HVAC Mode: Sofakrok"
    max: 20
    icon: mdi:thermostat

  previous_hvac_mode_mill_wifi_oil:
    name: "Previous HVAC Mode: Mill WiFi Oil"
    max: 20
    icon: mdi:thermostat

  previous_hvac_mode_varmekabler_bad:
    name: "Previous HVAC Mode: Varmekabler Bad"
    max: 20
    icon: mdi:thermostat

  previous_hvac_mode_varmekabler_gang:
    name: "Previous HVAC Mode: Varmekabler Gang"
    max: 20
    icon: mdi:thermostat
